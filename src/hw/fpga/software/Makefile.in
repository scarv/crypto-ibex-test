# Copyright (C) 2021 SCARV project <info@scarv.org>
#
# Use of this source code is restricted per the MIT license, a copy of which 
# can be found at https://opensource.org/licenses/MIT (or should be included 
# as LICENSE.txt within the associated archive or repository).

#--------------------------------------------------------------------
# Build software
#--------------------------------------------------------------------
SW ?= verify

include ${REPO_HOME}/src/sw/${SW}/Makefile.in

FPGA_DEF_CONF  = 
FPGA_SWCONF   = $(FPGA_DEF_CONF)

SOC_HAL       = ${REPO_HOME}/src/hw/fpga/soc/${SOC}/hal
FPGA_INCLUDES = ${SOC_HAL} $(SW_INCS)

FPGA_SOURCES  = $(wildcard $(addsuffix /*.c, ${FPGA_INCLUDES}))
FPGA_SOURCES += $(wildcard $(addsuffix /*.S, ${FPGA_INCLUDES}))
FPGA_SOURCES += $(SW_SRCS)
FPGA_HEADERS  = $(wildcard $(addsuffix /*.h, ${FPGA_INCLUDES}))

FPGA_GCC_FLAGS  = -march=rv32imac -mabi=ilp32  -DPREALLOCATE=1 -mcmodel=medany
FPGA_GCC_FLAGS += $(SW_CFLAGS) -std='gnu99' -O2
FPGA_GCC_FLAGS += -fno-builtin-printf -static -nostartfiles -T$(SOC_HAL)/lscript.ld
GCC_PREFIX = ${RISCV}/bin/riscv64-unknown-elf

FPGA_TARGET   = ${REPO_HOME}/build/fpga/fpga_${SW}.elf
FPGA_OUTBIN   = ${REPO_HOME}/build/fpga/fpga_${SW}.bin

# -----------------------------------------------------------------------------

${FPGA_TARGET} : ${FPGA_SOURCES} ${FPGA_HEADERS} 
	${GCC_PREFIX}-gcc ${FPGA_SWCONF} ${FPGA_GCC_FLAGS} ${GCC_PATHS} $(addprefix -I ,${FPGA_INCLUDES}) -o ${@} $(filter %.c, ${^}) $(filter %.S, ${^}) 

$(FPGA_OUTBIN) : $(FPGA_TARGET)
	@${GCC_PREFIX}-objcopy -O binary $< $@

${FPGA_TARGET}.asm : ${FPGA_TARGET}
	@${GCC_PREFIX}-objdump --disassemble-all ${<} > ${@}

fpga-run : $(FPGA_OUTBIN) ${FPGA_TARGET}.asm 
	$(FPGA)/script/upload.py --port $(PORT) --baud 115200 upload $(FPGA_OUTBIN) --stdout

#all   : ${TARGET}.elf ${TARGET}.asm
fpga-clean : 
	@rm --force ${FPGA_TARGET}
	@rm --force ${FPGA_TARGET}.asm
	@rm --force ${FPGA_OUTBIN}

# =============================================================================
